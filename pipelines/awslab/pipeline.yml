resources:

- name: cf-labs
  check_every: 30s
  type: git
  source:
    uri: {{cf_labs_git}}
    branch: {{cf_labs_git_branch}}

- name: terraform-state
  # Upped the freq to help with troubleshooting, feel free to drop
  check_every: 20s
  type: s3
  source:
    access_key_id: {{s3_access_key_id}}
    secret_access_key: {{s3_secret_access_key}}
    endpoint: {{s3_endpoint}}
    bucket: {{s3_bucket}}
    # This doesn't work with a fixed filename for no good reason
    regexp: '(.*).tfstate'



jobs:

- name: bootstrap-terraform-state
  serial_groups: [terraform]
  plan:
  - get: cf-labs
    trigger: true
  - task: create-terraform-state
    params:
      S3_BUCKET_TERRAFORM: {{s3_bucket}}
      S3_ENDPOINT: {{s3_endpoint}}
      AWS_ACCESS_KEY_ID: {{s3_access_key_id}}
      AWS_SECRET_ACCESS_KEY: {{s3_secret_access_key}}
    # This goes off and creates the tfstate (empty) and its bucket too if missing
    file: cf-labs/tasks/create-initial-terraform-state/task.yml

- name: pave-bosh-lite
  serial_groups: [terraform]
  plan:
  - aggregate:
    - get: cf-labs
    - get: terraform-state
      # Gets triggered by the terraform-state get because that only passes if bootstrap passed too
      trigger: true
  - task: plan-terraform
    config:
      platform: linux
      inputs:
        - name: cf-labs
        - name: terraform-state
      outputs:
        - name: terraform.tfplan
      image_resource:
        type: docker-image
        source:
          repository: pcfnorm/rootfs
      run:
        path: sh
        args:
          - -exc
          - |
            terraform init cf-labs/pipelines/awslab/terraform &&
            terraform plan -state terraform-state/terraform.tfstate \
            -var "aws_access_key={{aws_tf_access_key}}" \
            -var "aws_secret_key={{aws_tf_secret_key}}" \
            -out terraform.tfplan \
            cf-labs/pipelines/awslab/terraform
  - task: apply-terraform
    config:
      platform: linux
      inputs:
        - name: cf-labs
        - name: terraform.tfplan
      outputs:
        - name: terraform-state-out
      image_resource:
        type: docker-image
        source:
          repository: pcfnorm/rootfs
      run:
        path: sh
        args:
          - -exc
          - |
            terraform init cf-labs/pipelines/awslab/terraform &&
            terraform apply \
            -state-out terraform-state-out/terraform.tfstate \
            -var "aws_access_key={{aws_tf_access_key}}" \
            -var "aws_secret_key={{aws_tf_secret_key}}" \
            terraform.tfplan \
            cf-labs/pipelines/awslab/terraform
    ensure:
      put: terraform-state
      params:
        file: terraform-state-out/terraform.tfstate
        acl: private
