resources:

- name: cf-labs
  type: git
  source:
    uri: {{cf_labs_git}}
    branch: {{cf_labs_git_branch}}

- name: terraform-state
  # Upped the freq to help with troubleshooting, feel free to drop
  check_every: 20s
  type: s3
  source:
    access_key_id: {{s3_access_key_id}}
    secret_access_key: {{s3_secret_access_key}}
    endpoint: {{s3_endpoint}}
    bucket: {{s3_bucket}}
    # This doesn't work with a fixed filename for no good reason
    regexp: '(.*).tfstate'



jobs:

- name: bootstrap-terraform-state
  serial_groups: [terraform]
  plan:
  - get: cf-labs
    trigger: true
  - task: create-terraform-state
    params:
      S3_BUCKET_TERRAFORM: {{s3_bucket}}
      S3_ENDPOINT: {{s3_endpoint}}
      AWS_ACCESS_KEY_ID: {{s3_access_key_id}}
      AWS_SECRET_ACCESS_KEY: {{s3_secret_access_key}}
    # This goes off and creates the tfstate (empty) and its bucket too if missing
    file: cf-labs/tasks/create-initial-terraform-state/task.yml

- name: check-terraform-state
  serial_groups: [terraform]
  plan:
  - aggregate:
    - get: cf-labs
    - get: terraform-state
      # Gets triggered by the terraform-state get because that only passes if bootstrap passed too
      trigger: true
  - task: check-terraform-state
    config:
      platform: linux
      inputs:
        - name: cf-labs
        - name: terraform-state
      image_resource:
        type: docker-image
        source:
          repository: alpine/git
      run:
        path: sh
        args:
        - -c
        - |
          ls -la
          ls -la ./cf-labs
          ls -la ./terraform-state


















# jobs:
# - name: list-folders
#   plan:
#   - get: pcf-labs
#   - task: why
#     config:
#       platform: linux
#       inputs:
#       - name: pcf-labs
#       outputs:
#       - name: terraform
#       image_resource:
#         type: docker-image
#         source:
#           repository: alpine/git
#           # tag: 18.04
#       run:
#         path: sh
#         args:
#         - -c
#         - |
#           ls -la ./
#           echo "{mystate}" > ./terraform/terraform.tfstate
#   - task: hello
#     config:
#       platform: linux
#       inputs:
#       - name: terraform
#       image_resource:
#         type: docker-image
#         source:
#           repository: alpine/git
#           # tag: 18.04
#       run:
#         path: sh
#         args:
#         - -c
#         - |
#           ls -la ./
#   - put: terraform-state
#     params:
#       file: terraform/terraform.tfstate
#       acl: private
